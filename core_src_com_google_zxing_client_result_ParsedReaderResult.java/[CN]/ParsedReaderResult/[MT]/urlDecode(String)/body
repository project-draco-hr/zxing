{
  if (escaped == null) {
    return null;
  }
  char[] escapedArray=escaped.toCharArray();
  int first=findFirstEscape(escapedArray);
  if (first < 0) {
    return escaped;
  }
  int max=escapedArray.length;
  StringBuffer unescaped=new StringBuffer(max - 2);
  unescaped.append(escapedArray,0,first);
  for (int i=first; i < max; i++) {
    char c=escapedArray[i];
    if (c == '+') {
      unescaped.append(' ');
    }
 else     if (c == '%') {
      if (i >= max - 2) {
        unescaped.append('%');
      }
 else {
        int firstDigitValue=parseHexDigit(escapedArray[++i]);
        int secondDigitValue=parseHexDigit(escapedArray[++i]);
        if (firstDigitValue < 0 || secondDigitValue < 0) {
          unescaped.append('%');
          unescaped.append(escapedArray[i - 1]);
          unescaped.append(escapedArray[i]);
        }
        unescaped.append((char)((firstDigitValue << 4) + secondDigitValue));
      }
    }
 else {
      unescaped.append(c);
    }
  }
  return unescaped.toString();
}
