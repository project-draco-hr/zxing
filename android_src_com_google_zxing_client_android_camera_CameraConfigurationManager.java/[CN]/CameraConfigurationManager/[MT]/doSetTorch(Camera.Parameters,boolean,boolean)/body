{
  String flashMode;
  if (newSetting) {
    flashMode=findSettableValue(parameters.getSupportedFlashModes(),Camera.Parameters.FLASH_MODE_TORCH,Camera.Parameters.FLASH_MODE_ON);
  }
 else {
    flashMode=findSettableValue(parameters.getSupportedFlashModes(),Camera.Parameters.FLASH_MODE_OFF);
  }
  if (flashMode != null) {
    parameters.setFlashMode(flashMode);
  }
  SharedPreferences prefs=PreferenceManager.getDefaultSharedPreferences(context);
  if (!prefs.getBoolean(PreferencesActivity.KEY_DISABLE_EXPOSURE,true)) {
    if (!safeMode) {
      int minExposure=parameters.getMinExposureCompensation();
      int maxExposure=parameters.getMaxExposureCompensation();
      if (minExposure != 0 || maxExposure != 0) {
        float step=parameters.getExposureCompensationStep();
        int desiredCompensation;
        if (newSetting) {
          desiredCompensation=Math.max((int)(MIN_EXPOSURE_COMPENSATION / step),minExposure);
        }
 else {
          desiredCompensation=Math.min((int)(MAX_EXPOSURE_COMPENSATION / step),maxExposure);
        }
        Log.i(TAG,"Setting exposure compensation to " + desiredCompensation + " / "+ (step * desiredCompensation));
        parameters.setExposureCompensation(desiredCompensation);
      }
 else {
        Log.i(TAG,"Camera does not support exposure compensation");
      }
    }
  }
}
