{
  if (!ServletFileUpload.isMultipartContent(request)) {
    response.sendRedirect("badimage.jspx");
    return;
  }
  ServletFileUpload upload=new ServletFileUpload(diskFileItemFactory);
  upload.setFileSizeMax(MAX_IMAGE_SIZE);
  try {
    for (    FileItem item : (List<FileItem>)upload.parseRequest(request)) {
      if (!item.isFormField()) {
        if (item.getSize() <= MAX_IMAGE_SIZE) {
          log.info("Decoding uploaded file");
          InputStream is=item.getInputStream();
          try {
            processStream(is,response);
          }
  finally {
            is.close();
          }
        }
 else {
          throw new ServletException("File is too large: " + item.getSize());
        }
        break;
      }
    }
  }
 catch (  FileUploadException fue) {
    response.sendRedirect("badimage.jspx");
  }
}
