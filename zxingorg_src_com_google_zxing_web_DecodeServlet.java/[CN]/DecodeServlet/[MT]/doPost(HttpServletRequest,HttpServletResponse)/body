{
  if (!ServletFileUpload.isMultipartContent(request)) {
    log.info("File upload was not multipart");
    response.sendRedirect("badimage.jspx");
    return;
  }
  ServletFileUpload upload=new ServletFileUpload(diskFileItemFactory);
  upload.setFileSizeMax(MAX_IMAGE_SIZE);
  try {
    for (    FileItem item : upload.parseRequest(request)) {
      if (!item.isFormField()) {
        if (item.getSize() <= MAX_IMAGE_SIZE) {
          log.info("Decoding uploaded file");
          try (InputStream is=item.getInputStream()){
            processStream(is,request,response);
          }
         }
 else {
          log.info("Too large");
          response.sendRedirect("badimage.jspx");
        }
        break;
      }
    }
  }
 catch (  FileUploadException fue) {
    log.info(fue.toString());
    response.sendRedirect("badimage.jspx");
  }
}
