{
  if (!ServletFileUpload.isMultipartContent(request)) {
    log.fine("File upload was not multipart");
    response.sendRedirect("badimage.jspx");
    return;
  }
  ServletFileUpload upload=new ServletFileUpload(diskFileItemFactory);
  upload.setFileSizeMax(MAX_IMAGE_SIZE);
  try {
    for (    FileItem item : (List<FileItem>)upload.parseRequest(request)) {
      if (!item.isFormField()) {
        if (item.getSize() <= MAX_IMAGE_SIZE) {
          log.info("Decoding uploaded file");
          InputStream is=item.getInputStream();
          try {
            processStream(is,request,response);
          }
  finally {
            is.close();
          }
        }
 else {
          log.fine("Too large");
          response.sendRedirect("badimage.jspx");
        }
        break;
      }
    }
  }
 catch (  FileUploadException fue) {
    if (log.isLoggable(Level.FINE)) {
      log.fine(fue.toString());
    }
    response.sendRedirect("badimage.jspx");
  }
}
