{
  String imageURIString=request.getParameter("u");
  if (imageURIString == null || imageURIString.isEmpty()) {
    log.fine("URI was empty");
    response.sendRedirect("badurl.jspx");
    return;
  }
  imageURIString=imageURIString.trim();
  if (!(imageURIString.startsWith("http://") || imageURIString.startsWith("https://"))) {
    imageURIString="http://" + imageURIString;
  }
  URI imageURI;
  try {
    imageURI=new URI(imageURIString);
  }
 catch (  URISyntaxException urise) {
    if (log.isLoggable(Level.FINE)) {
      log.fine("URI was not valid: " + imageURIString);
    }
    response.sendRedirect("badurl.jspx");
    return;
  }
  HttpURLConnection connection=(HttpURLConnection)imageURI.toURL().openConnection();
  connection.setAllowUserInteraction(false);
  connection.setReadTimeout(5000);
  connection.setConnectTimeout(5000);
  connection.setRequestProperty("User-Agent","zxing.org");
  connection.setRequestProperty("Connection","close");
  try {
    try {
      connection.connect();
    }
 catch (    IOException ioe) {
      if (log.isLoggable(Level.FINE)) {
        log.fine(ioe.toString());
      }
      response.sendRedirect("badurl.jspx");
      return;
    }
    InputStream is=null;
    try {
      is=connection.getInputStream();
      if (connection.getResponseCode() != HttpServletResponse.SC_OK) {
        if (log.isLoggable(Level.FINE)) {
          log.fine("Unsuccessful return code: " + connection.getResponseCode());
        }
        response.sendRedirect("badurl.jspx");
        return;
      }
      if (connection.getHeaderFieldInt("Content-Length",0) > MAX_IMAGE_SIZE) {
        log.fine("Too large");
        response.sendRedirect("badimage.jspx");
        return;
      }
      log.info("Decoding " + imageURI);
      processStream(is,request,response);
    }
 catch (    IOException ioe) {
      if (log.isLoggable(Level.FINE)) {
        log.fine(ioe.toString());
      }
      response.sendRedirect("badurl.jspx");
    }
 finally {
      if (is != null) {
        consumeRemainder(is);
        is.close();
      }
    }
  }
  finally {
    connection.disconnect();
  }
}
