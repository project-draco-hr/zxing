{
  SQLiteOpenHelper helper=new DBHelper(activity);
  List<Result> items=new ArrayList<Result>();
  List<String> dialogItems=new ArrayList<String>();
  SQLiteDatabase db=null;
  Cursor cursor=null;
  try {
    db=helper.getReadableDatabase();
    cursor=db.query(DBHelper.TABLE_NAME,COLUMNS,null,null,null,null,DBHelper.TIMESTAMP_COL + " DESC");
    while (cursor.moveToNext()) {
      String text=cursor.getString(0);
      String format=cursor.getString(2);
      long timestamp=cursor.getLong(3);
      Result result=new Result(text,null,null,BarcodeFormat.valueOf(format),timestamp);
      items.add(result);
      StringBuilder displayResult=new StringBuilder();
      String display=cursor.getString(1);
      if (display == null || display.length() == 0) {
        display=result.getText();
      }
      displayResult.append(display);
      String details=cursor.getString(4);
      if (details != null && details.length() > 0) {
        displayResult.append(" : ").append(details);
      }
      dialogItems.add(displayResult.toString());
    }
  }
  finally {
    close(cursor,db);
  }
  Resources res=activity.getResources();
  dialogItems.add(res.getString(R.string.history_send));
  dialogItems.add(res.getString(R.string.history_clear_text));
  DialogInterface.OnClickListener clickListener=new HistoryClickListener(this,activity,items);
  AlertDialog.Builder builder=new AlertDialog.Builder(activity);
  builder.setTitle(R.string.history_title);
  builder.setItems(dialogItems.toArray(new String[dialogItems.size()]),clickListener);
  return builder.create();
}
