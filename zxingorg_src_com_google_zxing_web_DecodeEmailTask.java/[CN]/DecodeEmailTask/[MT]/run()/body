{
  log.info("Checking email...");
  Session session=Session.getInstance(sessionProperties,emailAuthenticator);
  Store store=null;
  Folder inbox=null;
  try {
    store=session.getStore("pop3");
    store.connect();
    inbox=store.getFolder("INBOX");
    inbox.open(Folder.READ_WRITE);
    int count=inbox.getMessageCount();
    if (count > 0) {
      log.info("Found " + count + " messages");
    }
    for (int i=1; i <= count; i++) {
      log.info("Processing message " + i);
      Message message=inbox.getMessage(i);
      processMessage(session,message);
    }
  }
 catch (  Throwable t) {
    log.log(Level.WARNING,"Unexpected error",t);
  }
 finally {
    closeResources(store,inbox);
  }
}
