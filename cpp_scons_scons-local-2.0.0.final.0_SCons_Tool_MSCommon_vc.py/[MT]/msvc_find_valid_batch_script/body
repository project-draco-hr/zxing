def msvc_find_valid_batch_script(env, version):
    debug('vc.py:msvc_find_valid_batch_script()')
    (host_platform, target_platform, req_target_platform) = get_host_target(env)
    try_target_archs = [target_platform]
    if ((not req_target_platform) and (target_platform == 'amd64')):
        try_target_archs.append('x86')
    d = None
    for tp in try_target_archs:
        env['TARGET_ARCH'] = tp
        debug(('vc.py:msvc_find_valid_batch_script() trying target_platform:%s' % tp))
        host_target = (host_platform, tp)
        if (not is_host_target_supported(host_target, version)):
            warn_msg = ('host, target = %s not supported for MSVC version %s' % (host_target, version))
            SCons.Warnings.warn(SCons.Warnings.VisualCMissingWarning, warn_msg)
        arg = _HOST_TARGET_ARCH_TO_BAT_ARCH[host_target]
        try:
            (vc_script, sdk_script) = find_batch_file(env, version, host_platform, tp)
            debug(('vc.py:msvc_find_valid_batch_script() vc_script:%s sdk_script:%s' % (vc_script, sdk_script)))
        except VisualCException as e:
            msg = str(e)
            debug(('Caught exception while looking for batch file (%s)' % msg))
            warn_msg = (('VC version %s not installed.  ' + 'C/C++ compilers are most likely not set correctly.\n') + ' Installed versions are: %s')
            warn_msg = (warn_msg % (version, cached_get_installed_vcs()))
            SCons.Warnings.warn(SCons.Warnings.VisualCMissingWarning, warn_msg)
            continue
        debug(('vc.py:msvc_find_valid_batch_script() use_script 2 %s, args:%s\n' % (repr(vc_script), arg)))
        if vc_script:
            try:
                d = script_env(vc_script, args=arg)
            except BatchFileExecutionError as e:
                debug(('vc.py:msvc_find_valid_batch_script() use_script 3: failed running VC script %s: %s: Error:%s' % (repr(vc_script), arg, e)))
                vc_script = None
        if ((not vc_script) and sdk_script):
            debug(('vc.py:msvc_find_valid_batch_script() use_script 4: trying sdk script: %s' % sdk_script))
            try:
                d = script_env(sdk_script, args=[])
            except BatchFileExecutionError as e:
                debug(('vc.py:msvc_find_valid_batch_script() use_script 5: failed running SDK script %s: Error:%s' % (repr(sdk_script), e)))
                continue
        elif ((not vc_script) and (not sdk_script)):
            debug('vc.py:msvc_find_valid_batch_script() use_script 6: Neither VC script nor SDK script found')
            continue
    if (not d):
        env['TARGET_ARCH'] = req_target_platform
    return d
