{
  int[] lastRange=null;
  for (int i=centerI, j=centerJ; i < maxI && i >= minI && j < maxJ && j >= minJ; i+=di, j+=dj) {
    int[] range;
    if (dj == 0) {
      range=blackWhiteRange(i,maxWhiteRun,minJ,maxJ,true);
    }
 else {
      range=blackWhiteRange(j,maxWhiteRun,minI,maxI,false);
    }
    if (range == null) {
      if (lastRange == null) {
        throw new ReaderException("Center of image not within barcode");
      }
      if (dj == 0) {
        int lastI=i - di;
        if (lastRange[0] < centerJ) {
          if (lastRange[1] > centerJ) {
            return new GenericResultPoint(di > 0 ? lastRange[0] : lastRange[1],lastI);
          }
          return new GenericResultPoint(lastRange[0],lastI);
        }
 else {
          return new GenericResultPoint(lastRange[1],lastI);
        }
      }
 else {
        int lastJ=j - dj;
        if (lastRange[0] < centerI) {
          if (lastRange[1] > centerI) {
            return new GenericResultPoint(lastJ,dj < 0 ? lastRange[0] : lastRange[1]);
          }
          return new GenericResultPoint(lastJ,lastRange[0]);
        }
 else {
          return new GenericResultPoint(lastJ,lastRange[1]);
        }
      }
    }
    lastRange=range;
  }
  throw new ReaderException("Couldn't find an end to barcode");
}
