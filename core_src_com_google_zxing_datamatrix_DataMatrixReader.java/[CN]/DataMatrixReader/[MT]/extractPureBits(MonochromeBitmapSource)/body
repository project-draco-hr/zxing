{
  int height=image.getHeight();
  int width=image.getWidth();
  int minDimension=Math.min(height,width);
  int borderWidth=0;
  while (borderWidth < minDimension && !image.isBlack(borderWidth,borderWidth)) {
    borderWidth++;
  }
  if (borderWidth == minDimension) {
    throw new ReaderException("No black pixels found along diagonal");
  }
  int moduleEnd=borderWidth + 1;
  while (moduleEnd < width && image.isBlack(moduleEnd,borderWidth)) {
    moduleEnd++;
  }
  if (moduleEnd == width) {
    throw new ReaderException("No end to black pixels found along row");
  }
  int moduleSize=moduleEnd - borderWidth;
  int columnEndOfSymbol=height - 1;
  while (columnEndOfSymbol >= 0 && !image.isBlack(borderWidth,columnEndOfSymbol)) {
    columnEndOfSymbol--;
  }
  if (columnEndOfSymbol < 0) {
    throw new ReaderException("Can't find end of bottommost black module");
  }
  columnEndOfSymbol++;
  if ((columnEndOfSymbol - borderWidth) % moduleSize != 0) {
    throw new ReaderException("Bad module size / width: " + moduleSize + " / "+ (columnEndOfSymbol - borderWidth));
  }
  int dimension=(columnEndOfSymbol - borderWidth) / moduleSize;
  borderWidth+=moduleSize >> 1;
  int sampleDimension=borderWidth + (dimension - 1) * moduleSize;
  if (sampleDimension >= width || sampleDimension >= height) {
    throw new ReaderException("Estimated pure image size is beyond image boundaries");
  }
  BitMatrix bits=new BitMatrix(dimension);
  for (int i=0; i < dimension; i++) {
    int iOffset=borderWidth + i * moduleSize;
    for (int j=0; j < dimension; j++) {
      if (image.isBlack(borderWidth + j * moduleSize,iOffset)) {
        bits.set(i,j);
      }
    }
  }
  return bits;
}
