{
  Rect rect=getFramingRectInPreview();
  int previewFormat=configManager.getPreviewFormat();
  String previewFormatString=configManager.getPreviewFormatString();
  SharedPreferences sharedPrefs=PreferenceManager.getDefaultSharedPreferences(context);
  boolean reverseImage=sharedPrefs.getBoolean(PreferencesActivity.KEY_REVERSE_IMAGE,false);
switch (previewFormat) {
case PixelFormat.YCbCr_420_SP:
case PixelFormat.YCbCr_422_SP:
    return new PlanarYUVLuminanceSource(data,width,height,rect.left,rect.top,rect.width(),rect.height(),reverseImage);
default :
  if ("yuv420p".equals(previewFormatString)) {
    return new PlanarYUVLuminanceSource(data,width,height,rect.left,rect.top,rect.width(),rect.height(),reverseImage);
  }
}
throw new IllegalArgumentException("Unsupported picture format: " + previewFormat + '/'+ previewFormatString);
}
