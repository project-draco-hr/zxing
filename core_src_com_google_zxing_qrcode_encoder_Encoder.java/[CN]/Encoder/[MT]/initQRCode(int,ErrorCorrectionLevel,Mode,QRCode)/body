{
  qrCode.setECLevel(ecLevel);
  qrCode.setMode(mode);
  for (int versionNum=1; versionNum <= 40; versionNum++) {
    Version version=Version.getVersionForNumber(versionNum);
    int numBytes=version.getTotalCodewords();
    Version.ECBlocks ecBlocks=version.getECBlocksForLevel(ecLevel);
    int numEcBytes=ecBlocks.getTotalECCodewords();
    int numRSBlocks=ecBlocks.getNumBlocks();
    int numDataBytes=numBytes - numEcBytes;
    if (numDataBytes >= getTotalInputBytes(numInputBits,version,mode)) {
      qrCode.setVersion(versionNum);
      qrCode.setNumTotalBytes(numBytes);
      qrCode.setNumDataBytes(numDataBytes);
      qrCode.setNumRSBlocks(numRSBlocks);
      qrCode.setNumECBytes(numEcBytes);
      qrCode.setMatrixWidth(version.getDimensionForVersion());
      return;
    }
  }
  throw new WriterException("Cannot find proper rs block info (input data too big?)");
}
