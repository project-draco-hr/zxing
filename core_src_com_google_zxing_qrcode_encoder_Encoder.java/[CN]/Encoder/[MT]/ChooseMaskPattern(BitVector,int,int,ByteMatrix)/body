{
  if (!QRCode.IsValidMatrixWidth(matrix.width())) {
    throw new WriterException("Invalid matrix width: " + matrix.width());
  }
  int min_penalty=Integer.MAX_VALUE;
  int best_mask_pattern=-1;
  for (int i=0; i < QRCode.kNumMaskPatterns; ++i) {
    final int mask_pattern=i;
    MatrixUtil.BuildMatrix(bits,ec_level,version,mask_pattern,matrix);
    final int penalty=MaskUtil.CalculateMaskPenalty(matrix);
    System.out.println("mask_pattern: " + mask_pattern + ", "+ "penalty: "+ penalty);
    if (penalty < min_penalty) {
      min_penalty=penalty;
      best_mask_pattern=mask_pattern;
    }
  }
  return best_mask_pattern;
}
