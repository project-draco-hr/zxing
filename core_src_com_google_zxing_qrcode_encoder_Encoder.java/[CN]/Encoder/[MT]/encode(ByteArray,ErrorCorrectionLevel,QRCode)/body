{
  final int mode=chooseMode(bytes);
  BitVector dataBits=new BitVector();
  appendBytes(bytes,mode,dataBits);
  final int numInputBytes=dataBits.sizeInBytes();
  initQRCode(numInputBytes,ecLevel,mode,qrCode);
  BitVector headerAndDataBits=new BitVector();
  appendModeInfo(qrCode.getMode(),headerAndDataBits);
  appendLengthInfo(bytes.size(),qrCode.getVersion(),qrCode.getMode(),headerAndDataBits);
  headerAndDataBits.appendBitVector(dataBits);
  terminateBits(qrCode.getNumDataBytes(),headerAndDataBits);
  BitVector finalBits=new BitVector();
  interleaveWithECBytes(headerAndDataBits,qrCode.getNumTotalBytes(),qrCode.getNumDataBytes(),qrCode.getNumRSBlocks(),finalBits);
  ByteMatrix matrix=new ByteMatrix(qrCode.getMatrixWidth(),qrCode.getMatrixWidth());
  qrCode.setMaskPattern(chooseMaskPattern(finalBits,qrCode.getECLevel(),qrCode.getVersion(),matrix));
  MatrixUtil.buildMatrix(finalBits,qrCode.getECLevel(),qrCode.getVersion(),qrCode.getMaskPattern(),matrix);
  qrCode.setMatrix(matrix);
  if (!qrCode.isValid()) {
    throw new WriterException("Invalid QR code: " + qrCode.toString());
  }
}
